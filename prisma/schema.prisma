generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  DOCTOR
  PATIENT
}

enum DoctorStatus {
  ACTIVE
  INACTIVE
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ExaminationType {
  IN_PERSON
  ONLINE
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  username  String?
  phone     String?
  fullName  String?
  avatar    String?
  address   String?
  role      UserRole @default(ADMIN)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refreshTokens RefreshToken[]
  doctor        Doctor?

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  code        String?  @unique
  description String?
  headId      String?  @unique
  head        Doctor?  @relation("DepartmentHead", fields: [headId], references: [id], onDelete: SetNull)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  specialties Specialty[]

  @@map("departments")
}

model Specialty {
  id           String      @id @default(uuid())
  name         String      @unique
  description  String?
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  doctors Doctor[]

  @@map("specialties")
}

model Doctor {
  id                 String       @id @default(uuid())
  userId             String       @unique
  user               User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  primarySpecialtyId String
  primarySpecialty   Specialty    @relation(fields: [primarySpecialtyId], references: [id])
  subSpecialty       String?
  professionalTitle  String?
  yearsOfExperience  Int
  consultationFee    Int
  bio                String?
  status             DoctorStatus @default(ACTIVE)
  deletedAt          DateTime?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  educations       DoctorEducation[]
  awards           DoctorAward[]
  certifications   DoctorCertification[]
  headOfDepartment Department?           @relation("DepartmentHead")
  schedules        DoctorSchedule[]

  @@index([userId])
  @@index([primarySpecialtyId])
  @@index([deletedAt])
  @@map("doctors")
}

model DoctorEducation {
  id             String   @id @default(uuid())
  doctorId       String
  doctor         Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  school         String
  degree         String
  graduationYear Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([doctorId])
  @@map("doctor_educations")
}

model DoctorAward {
  id           String   @id @default(uuid())
  doctorId     String
  doctor       Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  title        String
  organization String
  year         Int
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([doctorId])
  @@map("doctor_awards")
}

model DoctorCertification {
  id               String    @id @default(uuid())
  doctorId         String
  doctor           Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  certificateName  String
  issuingAuthority String
  licenseNumber    String
  issueDate        DateTime
  expiryDate       DateTime?
  documentUrl      String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([doctorId])
  @@index([licenseNumber])
  @@map("doctor_certifications")
}

model DoctorSchedule {
  id        String   @id @default(uuid())
  doctorId  String
  doctor    Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  startDate DateTime @db.Date
  endDate   DateTime @db.Date
  timezone  String   @default("Asia/Ho_Chi_Minh")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  timeSlots DoctorTimeSlot[]

  @@index([doctorId])
  @@index([startDate, endDate])
  @@index([isActive])
  @@map("doctor_schedules")
}

model DoctorTimeSlot {
  id              String          @id @default(uuid())
  scheduleId      String
  schedule        DoctorSchedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  dayOfWeek       DayOfWeek
  startTime       String
  endTime         String
  examinationType ExaminationType @default(IN_PERSON)
  maxPatients     Int             @default(10)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([scheduleId])
  @@index([dayOfWeek])
  @@map("doctor_time_slots")
}
