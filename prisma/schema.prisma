generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url     = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  phone         String?
  role          UserRole       @default(PATIENT)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  address       String?
  avatar        String?
  fullName      String?
  username      String?
  doctor        Doctor?
  patient       Patient?
  refreshTokens RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Department {
  id          String      @id @default(uuid())
  name        String      @unique
  code        String?     @unique
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  headId      String?     @unique
  head        Doctor?     @relation("DepartmentHead", fields: [headId], references: [id])
  specialties Specialty[]

  @@map("departments")
}

model Specialty {
  id           String      @id @default(uuid())
  name         String      @unique
  description  String?
  departmentId String?
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  doctors      Doctor[]
  department   Department? @relation(fields: [departmentId], references: [id])

  @@map("specialties")
}

model Doctor {
  id                 String                @id @default(uuid())
  userId             String                @unique
  primarySpecialtyId String
  subSpecialty       String?
  professionalTitle  String?
  yearsOfExperience  Int
  consultationFee    Int
  bio                String?
  status             DoctorStatus          @default(ACTIVE)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  deletedAt          DateTime?
  appointments       Appointment[]
  headOfDepartment   Department?           @relation("DepartmentHead")
  awards             DoctorAward[]
  certifications     DoctorCertification[]
  educations         DoctorEducation[]
  schedules          DoctorSchedule[]
  primarySpecialty   Specialty             @relation(fields: [primarySpecialtyId], references: [id])
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([primarySpecialtyId])
  @@index([deletedAt])
  @@map("doctors")
}

model DoctorEducation {
  id             String   @id @default(uuid())
  doctorId       String
  school         String
  degree         String
  graduationYear Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  doctor         Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@map("doctor_educations")
}

model DoctorAward {
  id           String   @id @default(uuid())
  doctorId     String
  title        String
  organization String
  year         Int
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  doctor       Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@map("doctor_awards")
}

model DoctorCertification {
  id               String    @id @default(uuid())
  doctorId         String
  certificateName  String
  issuingAuthority String
  licenseNumber    String
  issueDate        DateTime
  expiryDate       DateTime?
  documentUrl      String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  doctor           Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([licenseNumber])
  @@map("doctor_certifications")
}

model DoctorSchedule {
  id        String           @id @default(uuid())
  doctorId  String
  startDate DateTime         @db.Date
  endDate   DateTime         @db.Date
  timezone  String           @default("Asia/Ho_Chi_Minh")
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  doctor    Doctor           @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  timeSlots DoctorTimeSlot[]

  @@index([doctorId])
  @@index([startDate, endDate])
  @@index([isActive])
  @@map("doctor_schedules")
}

model DoctorTimeSlot {
  id              String          @id @default(uuid())
  scheduleId      String
  dayOfWeek       DayOfWeek
  startTime       String
  endTime         String
  examinationType ExaminationType @default(IN_PERSON)
  maxPatients     Int             @default(10)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  appointments    Appointment[]
  schedule        DoctorSchedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([dayOfWeek])
  @@map("doctor_time_slots")
}

model Patient {
  id                    String         @id @default(uuid())
  userId                String         @unique
  height                Float?
  weight                Float?
  bloodType             String?
  allergies             String?
  dateOfBirth           DateTime?
  gender                Gender?
  healthInsuranceNumber String?
  emergencyContact      String?
  identityNumber        String?
  chronicDisease        String?
  deletedAt             DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  appointments          Appointment[]
  conversations         Conversation[]
  user                  User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deletedAt])
  @@map("patients")
}

model Appointment {
  id                 String                @id @default(uuid())
  patientId          String
  doctorId           String
  timeSlotId         String
  appointmentDate    DateTime              @db.Date
  status             AppointmentStatus     @default(PENDING)
  examinationType    ExaminationType
  symptoms           String?
  notes              String?
  diagnosis          String?
  prescription       String?
  cancelledAt        DateTime?
  cancelledById      String?
  cancellationReason CancellationReason?
  cancellationNote   String?
  consultationFee    Int?
  medicineFee        Int                   @default(0)
  totalFee           Int                   @default(0)
  completedAt        DateTime?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  documents          AppointmentDocument[]
  prescriptionItems  PrescriptionItem[]
  payments           Payment[]
  doctor             Doctor                @relation(fields: [doctorId], references: [id])
  patient            Patient               @relation(fields: [patientId], references: [id])
  timeSlot           DoctorTimeSlot        @relation(fields: [timeSlotId], references: [id])

  @@index([patientId])
  @@index([doctorId])
  @@index([timeSlotId])
  @@index([appointmentDate])
  @@index([status])
  @@map("appointments")
}

model AppointmentDocument {
  id              String      @id @default(uuid())
  appointmentId   String
  title           String
  documentType    String
  documentUrl     String
  uploadedById    String
  notes           String?
  fileContentHash String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  appointment     Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@map("appointment_documents")
}

model MedicineCategory {
  id          String   @id @default(uuid())
  name        String   @unique   // Tên nhóm thuốc (Kháng sinh, Giảm đau, ...)
  code        String   @unique   // Mã nhóm thuốc (ANTIBIOTICS, ANALGESICS, ...)
  description String?   // Mô tả nhóm thuốc
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  medicines Medicine[]

  @@map("medicine_categories")
}

/// Thuốc
model Medicine {
  id                   String            @id @default(uuid())
  name                 String            // Tên thuốc (Paracetamol 500mg)
  code                 String            @unique   // Mã thuốc
  activeIngredient     String?           // Hoạt chất
  description          String?           // Mô tả / Công dụng (Giảm đau, hạ sốt)
  unit                 MedicineUnit      // Đơn vị tính (Tablets, Capsules, ...)
  dosage               String?           // Hàm lượng (500mg, 100ml, ...)
  manufacturer         String?           // Nhà sản xuất
  categoryId           String?           // Mã nhóm thuốc (FK)
  category             MedicineCategory? @relation(fields: [categoryId], references: [id])
  lowStockThreshold    Int               @default(100)   // Ngưỡng cảnh báo sắp hết hàng
  requiresPrescription Boolean           @default(false) // Thuốc kê đơn
  isActive             Boolean           @default(true)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  batches              MedicineBatch[]

  @@index([name])
  @@index([code])
  @@index([categoryId])
  @@map("medicines")
}
  
model MedicineBatch {
  id                String             @id @default(uuid())
  medicineId        String
  batchNumber       String
  quantity          Int
  currentStock      Int
  unitPrice         Int
  sellingPrice      Int
  manufactureDate   DateTime?
  expiryDate        DateTime
  manufacturer      String?
  supplier          String?
  status            BatchStatus        @default(IN_STOCK)
  notes             String?
  deletedAt         DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  medicine          Medicine           @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  prescriptionItems PrescriptionItem[]

  @@unique([medicineId, batchNumber])
  @@index([medicineId])
  @@index([expiryDate])
  @@index([status])
  @@index([deletedAt])
  @@map("medicine_batches")
}

model PrescriptionItem {
  id              String        @id @default(uuid())
  appointmentId   String
  medicineBatchId String
  quantity        Int
  dosage          String
  instructions    String?
  unitPrice       Int
  totalPrice      Int
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  appointment     Appointment   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  medicineBatch   MedicineBatch @relation(fields: [medicineBatchId], references: [id])

  @@index([appointmentId])
  @@index([medicineBatchId])
  @@map("prescription_items")
}

model Payment {
  id               String               @id @default(uuid())
  paymentCode      String               @unique
  appointmentId    String
  appointment      Appointment          @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  type             PaymentType          @default(CONSULTATION)
  amount           Int                  @default(0)
  method           PaymentMethod
  status           PaymentStatus        @default(PENDING)
  dataHash         String?
  blockchainTxHash String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  transactions     PaymentTransaction[]

  @@index([appointmentId])
  @@index([paymentCode])
  @@index([blockchainTxHash])
  @@map("payments")
}

model PaymentTransaction {
  id                 Int      @id @default(autoincrement())
  gateway            String   @db.VarChar(100)
  transactionDate    DateTime @default(now())
  accountNumber      String   @db.VarChar(100)
  subAccount         String?  @db.VarChar(250)
  amountIn           Int      @default(0)
  amountOut          Int      @default(0)
  accumulated        Int      @default(0)
  code               String?  @db.VarChar(250)
  transactionContent String?  @db.Text
  referenceNumber    String?  @db.VarChar(255)
  body               String?  @db.Text
  paymentId          String?
  payment            Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  createdAt          DateTime @default(now())

  @@index([paymentId])
  @@map("payment_transactions")
}
model BlockchainTransaction {
  id          String              @id @default(uuid())
  txHash      String              @unique
  dataHash    String
  recordType  BlockchainRecordType
  recordId    String
  blockNumber Int?
  gasUsed     String?
  status      BlockchainTxStatus  @default(PENDING)
  createdAt   DateTime            @default(now())
  confirmedAt DateTime?

  @@index([recordType, recordId])
  @@index([txHash])
  @@map("blockchain_transactions")
}

enum BlockchainRecordType {
  PAYMENT
  MEDICAL_RECORD
  PRESCRIPTION
  CREDENTIAL
}

enum BlockchainTxStatus {
  PENDING
  CONFIRMED
  FAILED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
}

enum PaymentType {
  CONSULTATION
  MEDICINE
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}
enum UserRole {
  ADMIN
  DOCTOR
  PATIENT
}

enum DoctorStatus {
  ACTIVE
  INACTIVE
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ExaminationType {
  IN_PERSON
  ONLINE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

/// Trạng thái lịch hẹn
enum AppointmentStatus {
  PENDING   // Chờ xác nhận
  CONFIRMED // Đã xác nhận
  IN_PROGRESS // Đang khám
  COMPLETED   // Hoàn thành
  CANCELLED   // Đã hủy
  NO_SHOW     // Không đến khám
}

/// Lý do hủy lịch hẹn
enum CancellationReason {
  PATIENT_REQUEST // Bệnh nhân yêu cầu hủy
  DOCTOR_UNAVAILABLE // Bác sĩ không có mặt
  EMERGENCY // Trường hợp khẩn cấp
  SCHEDULE_CONFLICT // Xung đột lịch trình
  OTHER // Lý do khác
}

enum MedicineUnit {
  TABLET // Viên nén
  CAPSULE // Viên nang
  SACHET // Gói
  BOTTLE // Chai
  TUBE // Tuýp
  AMPOULE // Ống tiêm
  VIAL // Lọ
  BOX // Hộp
}

/// Trạng thái lô thuốc
enum BatchStatus {
  IN_STOCK // Còn hàng
  LOW_STOCK // Sắp hết hàng
  OUT_OF_STOCK // Hết hàng
  EXPIRED // Hết hạn
  DISPOSED // Đã tiêu hủy
}

model Conversation {
  id              String               @id @default(uuid())
  patientId       String
  subject         String?
  status          ConversationStatus   @default(OPEN)
  priority        ConversationPriority @default(NORMAL)
  assignedAdminId String?
  lastMessageAt   DateTime?
  closedAt        DateTime?
  closedById      String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  patient         Patient              @relation(fields: [patientId], references: [id], onDelete: Cascade)
  messages        Message[]

  @@index([patientId])
  @@index([status])
  @@index([priority])
  @@index([assignedAdminId])
  @@index([lastMessageAt])
  @@index([createdAt])
  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  senderId       String
  senderRole     UserRole
  content        String       @db.Text
  messageType    MessageType  @default(TEXT)
  attachmentUrl  String?
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([isRead])
  @@index([createdAt])
  @@map("messages")
}

enum ConversationStatus {
  OPEN
  PENDING
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum ConversationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum MessageType {
  TEXT
  IMAGE
  FILE
}
