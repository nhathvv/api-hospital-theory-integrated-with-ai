generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url     = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  phone         String?
  role          UserRole       @default(PATIENT)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  address       String?
  avatar        String?
  fullName      String?
  username      String?
  doctor        Doctor?
  patient       Patient?
  refreshTokens RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Department {
  id          String      @id @default(uuid())
  name        String      @unique
  code        String?     @unique
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  headId      String?     @unique
  head        Doctor?     @relation("DepartmentHead", fields: [headId], references: [id])
  specialties Specialty[]

  @@map("departments")
}

model Specialty {
  id           String      @id @default(uuid())
  name         String      @unique
  description  String?
  departmentId String?
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  doctors      Doctor[]
  department   Department? @relation(fields: [departmentId], references: [id])

  @@map("specialties")
}

model Doctor {
  id                 String                @id @default(uuid())
  userId             String                @unique
  primarySpecialtyId String
  subSpecialty       String?
  professionalTitle  String?
  yearsOfExperience  Int
  consultationFee    Int
  bio                String?
  status             DoctorStatus          @default(ACTIVE)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  deletedAt          DateTime?
  appointments       Appointment[]
  headOfDepartment   Department?           @relation("DepartmentHead")
  awards             DoctorAward[]
  certifications     DoctorCertification[]
  educations         DoctorEducation[]
  schedules          DoctorSchedule[]
  primarySpecialty   Specialty             @relation(fields: [primarySpecialtyId], references: [id])
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([primarySpecialtyId])
  @@index([deletedAt])
  @@map("doctors")
}

model DoctorEducation {
  id             String   @id @default(uuid())
  doctorId       String
  school         String
  degree         String
  graduationYear Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  doctor         Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@map("doctor_educations")
}

model DoctorAward {
  id           String   @id @default(uuid())
  doctorId     String
  title        String
  organization String
  year         Int
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  doctor       Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@map("doctor_awards")
}

model DoctorCertification {
  id               String    @id @default(uuid())
  doctorId         String
  certificateName  String
  issuingAuthority String
  licenseNumber    String
  issueDate        DateTime
  expiryDate       DateTime?
  documentUrl      String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  doctor           Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([licenseNumber])
  @@map("doctor_certifications")
}

model DoctorSchedule {
  id        String           @id @default(uuid())
  doctorId  String
  startDate DateTime         @db.Date
  endDate   DateTime         @db.Date
  timezone  String           @default("Asia/Ho_Chi_Minh")
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  doctor    Doctor           @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  timeSlots DoctorTimeSlot[]

  @@index([doctorId])
  @@index([startDate, endDate])
  @@index([isActive])
  @@map("doctor_schedules")
}

model DoctorTimeSlot {
  id              String          @id @default(uuid())
  scheduleId      String
  dayOfWeek       DayOfWeek
  startTime       String
  endTime         String
  examinationType ExaminationType @default(IN_PERSON)
  maxPatients     Int             @default(10)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  appointments    Appointment[]
  schedule        DoctorSchedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([dayOfWeek])
  @@map("doctor_time_slots")
}

model Patient {
  id                    String        @id @default(uuid())
  userId                String        @unique
  height                Float?
  weight                Float?
  bloodType             String?
  allergies             String?
  dateOfBirth           DateTime?
  gender                Gender?
  healthInsuranceNumber String?
  emergencyContact      String?
  identityNumber        String?   // Số CMND/CCCD
  chronicDisease        String?   // Bệnh mãn tính
  deletedAt             DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  appointments          Appointment[]
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deletedAt])
  @@map("patients")
}

model Appointment {
  id                 String                @id @default(uuid())
  patientId          String
  doctorId           String
  timeSlotId         String
  appointmentDate    DateTime              @db.Date
  status             AppointmentStatus     @default(PENDING)
  examinationType    ExaminationType
  symptoms           String?
  notes              String?
  diagnosis          String?
  prescription       String?
  cancelledAt        DateTime?
  cancelledById      String?
  cancellationReason CancellationReason?
  cancellationNote   String?
  consultationFee    Int?
  medicineFee        Int                   @default(0)
  totalFee           Int                   @default(0)
  completedAt        DateTime?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  documents          AppointmentDocument[]
  prescriptionItems  PrescriptionItem[]
  payment            Payment?
  doctor             Doctor                @relation(fields: [doctorId], references: [id])
  patient            Patient               @relation(fields: [patientId], references: [id])
  timeSlot           DoctorTimeSlot        @relation(fields: [timeSlotId], references: [id])

  @@index([patientId])
  @@index([doctorId])
  @@index([timeSlotId])
  @@index([appointmentDate])
  @@index([status])
  @@map("appointments")
}

/// Tài liệu y tế của lịch hẹn (kết quả xét nghiệm, X-quang, MRI, ...)
model AppointmentDocument {
  id            String      @id @default(uuid())
  appointmentId String                // Mã lịch hẹn
  title         String                // Tiêu đề tài liệu
  documentType  String                // Loại tài liệu (LAB_RESULT, X_RAY, MRI, PRESCRIPTION, ...)
  documentUrl   String                // Đường dẫn file
  uploadedById  String                // Người tải lên (userId)
  notes         String?               // Ghi chú
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@map("appointment_documents")
}

model MedicineCategory {
  id          String   @id @default(uuid())
  name        String   @unique   // Tên nhóm thuốc (Kháng sinh, Giảm đau, ...)
  code        String   @unique   // Mã nhóm thuốc (ANTIBIOTICS, ANALGESICS, ...)
  description String?   // Mô tả nhóm thuốc
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  medicines Medicine[]

  @@map("medicine_categories")
}

/// Thuốc
model Medicine {
  id                   String            @id @default(uuid())
  name                 String            // Tên thuốc (Paracetamol 500mg)
  code                 String            @unique   // Mã thuốc
  activeIngredient     String?           // Hoạt chất
  description          String?           // Mô tả / Công dụng (Giảm đau, hạ sốt)
  unit                 MedicineUnit      // Đơn vị tính (Tablets, Capsules, ...)
  dosage               String?           // Hàm lượng (500mg, 100ml, ...)
  manufacturer         String?           // Nhà sản xuất
  categoryId           String?           // Mã nhóm thuốc (FK)
  category             MedicineCategory? @relation(fields: [categoryId], references: [id])
  lowStockThreshold    Int               @default(100)   // Ngưỡng cảnh báo sắp hết hàng
  requiresPrescription Boolean           @default(false) // Thuốc kê đơn
  isActive             Boolean           @default(true)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  batches              MedicineBatch[]

  @@index([name])
  @@index([code])
  @@index([categoryId])
  @@map("medicines")
}
  
model MedicineBatch {
  id                String             @id @default(uuid())
  medicineId        String
  batchNumber       String
  quantity          Int
  currentStock      Int
  unitPrice         Int
  sellingPrice      Int
  manufactureDate   DateTime?
  expiryDate        DateTime
  manufacturer      String?
  supplier          String?
  status            BatchStatus        @default(IN_STOCK)
  notes             String?
  deletedAt         DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  medicine          Medicine           @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  prescriptionItems PrescriptionItem[]

  @@unique([medicineId, batchNumber])
  @@index([medicineId])
  @@index([expiryDate])
  @@index([status])
  @@index([deletedAt])
  @@map("medicine_batches")
}

model PrescriptionItem {
  id              String        @id @default(uuid())
  appointmentId   String
  medicineBatchId String
  quantity        Int
  dosage          String
  instructions    String?
  unitPrice       Int
  totalPrice      Int
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  appointment     Appointment   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  medicineBatch   MedicineBatch @relation(fields: [medicineBatchId], references: [id])

  @@index([appointmentId])
  @@index([medicineBatchId])
  @@map("prescription_items")
}

model Payment {
  id            String        @id @default(uuid())
  paymentCode   String        @unique
  appointmentId String        @unique
  appointment   Appointment   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([appointmentId])
  @@index([paymentCode])
  @@map("payments")
}
model PaymentTransaction {
  id                 Int      @id @default(autoincrement()) // // ID giao dịch trên SePay
  gateway            String   @db.VarChar(100) // Tên cổng thanh toán
  transactionDate    DateTime @default(now()) //  Thời gian xảy ra giao dịch phía ngân hàng
  accountNumber      String   @db.VarChar(100) // Số tài khoản ngân hàng
  subAccount         String?  @db.VarChar(250) // Mã tài khoản phụ (nếu có)
  amountIn           Int      @default(0) // Số tiền nhận vào (VND)
  amountOut          Int      @default(0) // Số tiền chuyển ra (VND)
  accumulated        Int      @default(0) // Số dư tích lũy (VND)
  code               String?  @db.VarChar(250) //  Mã code thanh toán (sepay tự nhận diện dựa vào cấu hình tại Công ty -> Cấu hình chung)
  transactionContent String?  @db.Text // Nội dung giao dịch
  referenceNumber    String?  @db.VarChar(255) // Số tham chiếu từ ngân hàng
  body               String?  @db.Text // Dữ liệu gốc từ webhook
  createdAt DateTime @default(now())
}
enum PaymentMethod {
  CASH
  BANK_TRANSFER
}
enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}
enum UserRole {
  ADMIN
  DOCTOR
  PATIENT
}

enum DoctorStatus {
  ACTIVE
  INACTIVE
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ExaminationType {
  IN_PERSON
  ONLINE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

/// Trạng thái lịch hẹn
enum AppointmentStatus {
  PENDING   // Chờ xác nhận
  CONFIRMED // Đã xác nhận
  IN_PROGRESS // Đang khám
  COMPLETED   // Hoàn thành
  CANCELLED   // Đã hủy
  NO_SHOW     // Không đến khám
}

/// Lý do hủy lịch hẹn
enum CancellationReason {
  PATIENT_REQUEST // Bệnh nhân yêu cầu hủy
  DOCTOR_UNAVAILABLE // Bác sĩ không có mặt
  EMERGENCY // Trường hợp khẩn cấp
  SCHEDULE_CONFLICT // Xung đột lịch trình
  OTHER // Lý do khác
}

enum MedicineUnit {
  TABLET // Viên nén
  CAPSULE // Viên nang
  SACHET // Gói
  BOTTLE // Chai
  TUBE // Tuýp
  AMPOULE // Ống tiêm
  VIAL // Lọ
  BOX // Hộp
}

/// Trạng thái lô thuốc
enum BatchStatus {
  IN_STOCK // Còn hàng
  LOW_STOCK // Sắp hết hàng
  OUT_OF_STOCK // Hết hàng
  EXPIRED // Hết hạn
  DISPOSED // Đã tiêu hủy
}
